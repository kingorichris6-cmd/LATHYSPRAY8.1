<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Supervisor Dashboard</title>
  <style>
    body { font-family: Arial; background:#fffdf7; margin:0; padding:16px; }
    .topbar { display:flex; gap:10px; align-items:center; }
    .topbar a, .topbar button { padding:8px 10px; border-radius:8px; border:0; cursor:pointer; background:#d48a00; color:#fff; text-decoration:none }
    .table-wrap { overflow:auto; border:1px solid #eee; border-radius:8px; background:#fff; margin-top:12px; }
    table { width:max-content; min-width:100%; border-collapse:collapse; font-size:13px; }
    th, td { border:1px solid #e6e6e6; padding:6px; white-space:nowrap; }
    th { background:#ffe9b3; }
    td[contenteditable="true"]{ background:#fffef3; }
    .searchbox { margin-left:auto; display:flex; gap:6px; align-items:center }
  </style>
</head>
<body>
  <div class="topbar">
    <a href="index.html">Home</a>
    <a href="viewer.html">Viewer</a>
    <a href="agronomist.html">Agronomist</a>
    <a href="farmreport.html">Farm Report</a>
    <button style="margin-left:auto" onclick="logout()">Logout</button>
  </div>

  <h1>Supervisor Dashboard</h1>

  <div style="display:flex; gap:8px; align-items:center; margin-top:10px;">
    <input id="q" placeholder="Search...">
    <button onclick="search()">Search</button>
    <button onclick="clearSearch()">Clear</button>
  </div>

  <div class="table-wrap">
    <table id="tbl">
      <thead>
        <!-- keep the same two-row header structure as agronomist for consistency -->
        <tr>
          <th rowspan="2">ID</th><th rowspan="2">Farm</th><th rowspan="2">GH</th><th rowspan="2">AREA</th><th rowspan="2">CROP</th><th rowspan="2">VARIETY</th><th rowspan="2">MODE</th><th rowspan="2">METHOD</th><th rowspan="2">TIME</th>
          <th colspan="5">MON</th><th colspan="5">TUE</th><th colspan="5">WED</th><th colspan="5">THU</th><th colspan="5">FRI</th><th colspan="5">SAT</th><th colspan="5">SUN</th>
          <th rowspan="2">Target</th><th rowspan="2">Justification</th><th rowspan="2">Morning</th><th rowspan="2">Evening</th><th rowspan="2">Prepared By</th><th rowspan="2">Agronomist Remarks</th><th rowspan="2">Supervisor Remarks</th><th rowspan="2">Action</th>
        </tr>
        <tr>
          <!-- sub headers (same pattern) -->
          <th>Rate</th><th>Vol(L)</th><th>Chemical</th><th>Area</th><th>Mode</th>
          <th>Rate</th><th>Vol(L)</th><th>Chemical</th><th>Area</th><th>Mode</th>
          <th>Rate</th><th>Vol(L)</th><th>Chemical</th><th>Area</th><th>Mode</th>
          <th>Rate</th><th>Vol(L)</th><th>Chemical</th><th>Area</th><th>Mode</th>
          <th>Rate</th><th>Vol(L)</th><th>Chemical</th><th>Area</th><th>Mode</th>
          <th>Rate</th><th>Vol(L)</th><th>Chemical</th><th>Area</th><th>Mode</th>
          <th>Rate</th><th>Vol(L)</th><th>Chemical</th><th>Area</th><th>Mode</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
async function load(){
  try{
    const res = await fetch('/agro', { credentials: 'same-origin' });
    if (!res.ok) { if (res.status===401) location.href='login.html'; return; }
    const rows = await res.json();
    render(rows);
  }catch(err){ console.error(err); alert('Load failed'); }
}

function render(rows){
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = rows.map(r => {
    // build cells same order as agronomist
    const p = k => (r[k]||'');
    return `<tr data-id="${r.id||''}">
      <td>${p('id')}</td>
      <td>${p('farm')}</td><td>${p('gh')}</td><td>${p('area')}</td><td>${p('crop')}</td><td>${p('variety')}</td><td>${p('mode')}</td><td>${p('method')}</td><td>${p('time')}</td>

      <td>${p('mon_rate')}</td><td>${p('mon_vol')}</td><td>${p('mon_chemical')}</td><td>${p('mon_area')}</td><td>${p('mon_mode')}</td>
      <td>${p('tue_rate')}</td><td>${p('tue_vol')}</td><td>${p('tue_chemical')}</td><td>${p('tue_area')}</td><td>${p('tue_mode')}</td>
      <td>${p('wed_rate')}</td><td>${p('wed_vol')}</td><td>${p('wed_chemical')}</td><td>${p('wed_area')}</td><td>${p('wed_mode')}</td>
      <td>${p('thu_rate')}</td><td>${p('thu_vol')}</td><td>${p('thu_chemical')}</td><td>${p('thu_area')}</td><td>${p('thu_mode')}</td>
      <td>${p('fri_rate')}</td><td>${p('fri_vol')}</td><td>${p('fri_chemical')}</td><td>${p('fri_area')}</td><td>${p('fri_mode')}</td>
      <td>${p('sat_rate')}</td><td>${p('sat_vol')}</td><td>${p('sat_chemical')}</td><td>${p('sat_area')}</td><td>${p('sat_mode')}</td>
      <td>${p('sun_rate')}</td><td>${p('sun_vol')}</td><td>${p('sun_chemical')}</td><td>${p('sun_area')}</td><td>${p('sun_mode')}</td>

      <td>${p('target')}</td><td>${p('justification')}</td><td>${p('morning')}</td><td>${p('evening')}</td><td>${p('preparedBy')}</td><td>${p('agronomistRemarks')}</td>
      <td contenteditable="true">${p('supervisorRemarks')}</td>
      <td><button onclick="saveRemarks(this)">Save</button></td>
    </tr>`;
  }).join('');
}

async function saveRemarks(btn){
  const tr = btn.closest('tr');
  const id = Number(tr.dataset.id);
  const remarksCell = tr.children[ tr.children.length - 2 ];
  const text = remarksCell.innerText.trim();
  try{
    const res = await fetch('/agro/supervisor-remarks', {
      method:'POST', credentials:'same-origin',
      headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id, supervisorRemarks: text })
    });
    const d = await res.json();
    if (!d.success) { alert('Save failed'); return; }
    alert('Saved');
  }catch(err){ console.error(err); alert('Save failed'); }
}

function search(){
  const q = (document.getElementById('q').value||'').trim().toLowerCase();
  document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
  });
}
function clearSearch(){ document.getElementById('q').value=''; search(); }
async function logout(){ await fetch('/logout', { method:'POST', credentials:'same-origin' }); location.href='login.html'; }

load();
</script>
</body>
</html>
