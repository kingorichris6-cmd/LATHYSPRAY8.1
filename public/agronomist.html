<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Agronomist Dashboard</title>
  <style>
    body {
  font-family: Arial;
  margin: 0;
  padding: 16px;

  /* Background image */
  background-image: url("https://media.licdn.com/dms/image/v2/D4D22AQF0A909R6xIQg/feedshare-shrink_800/feedshare-shrink_800/0/1713288000180?e=2147483647&v=beta&t=SUy7E7JhE6XNMBozDtAWj3zpE_LtBnBgYWQ-OGLFHx4");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

    h1 { margin:0 0 10px; }
    .topbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .topbar a, .topbar button { padding:8px 10px; border-radius:8px; border:0; cursor:pointer; background:#138a36; color:#fff; text-decoration:none }
    .tools { display:flex; gap:8px; flex-wrap:wrap; margin:12px 0; }
    input, select, button { padding:8px; border:1px solid #ddd; border-radius:8px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:8px; }
    .table-wrap { overflow:auto; border:1px solid #eee; border-radius:8px; background:#fff; margin-top:12px; max-height:600px; }

    table { width:max-content; min-width:100%; border-collapse: collapse; font-size:13px; }
    th, td { border:1px solid #e6e6e6; padding:6px; vertical-align:top; white-space:nowrap; }

    th.top { background:#cdeccd; position: sticky; top:0; z-index:2; }
    th.sub { background:#eaf7ea; position: sticky; top:36px; z-index:1; }

    td[contenteditable="true"]{ background:#fffef3; }
    .searchbox { margin-left:auto; display:flex; gap:6px; align-items:center }
    mark { background: #ffef88; }
  </style>

  <!-- SheetJS for client-side Excel import/export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="topbar">
    <a href="viewer.html">Viewer</a>
    <a href="supervisor.html">Supervisor</a>
    <a href="farmreport.html">Farm Report</a>
    <button style="margin-left:auto" onclick="logout()">Logout</button>
  </div>

  <h1>Lathyflora â€” Agronomist Dashboard</h1>

  <h3>Quick Add (same columns as table â€” with autosuggest)</h3>

  <div class="grid" id="quickAdd">
    <input id="q_farm" list="dl_farm" placeholder="Farm">
    <input id="q_gh" list="dl_gh" placeholder="GH">
    <input id="q_area" list="dl_area" placeholder="AREA">
    <input id="q_crop" list="dl_crop" placeholder="CROP">
    <input id="q_variety" list="dl_variety" placeholder="VARIETY">
    <input id="q_mode" list="dl_mode" placeholder="MODE">
    <input id="q_method" list="dl_method" placeholder="METHOD">
    <input id="q_time" list="dl_time" placeholder="TIME">

    <input id="q_mon" placeholder="MONDAY">
    <input id="q_mon_rate" placeholder="MON Rate">
    <input id="q_mon_vol" placeholder="MON Vol (L)">
    <input id="q_mon_chem" placeholder="MON Chemical">
    <input id="q_mon_area" placeholder="MON Area">
    <input id="q_mon_mode" placeholder="MON Mode">

    <input id="q_tue" placeholder="TUESDAY">
    <input id="q_tue_rate" placeholder="TUE Rate">
    <input id="q_tue_vol" placeholder="TUE Vol (L)">
    <input id="q_tue_chem" placeholder="TUE Chemical">
    <input id="q_tue_area" placeholder="TUE Area">
    <input id="q_tue_mode" placeholder="TUE Mode">

    <input id="q_wed" placeholder="WEDNESDAY">
    <input id="q_wed_rate" placeholder="WED Rate">
    <input id="q_wed_vol" placeholder="WED Vol (L)">
    <input id="q_wed_chem" placeholder="WED Chemical">
    <input id="q_wed_area" placeholder="WED Area">
    <input id="q_wed_mode" placeholder="WED Mode">

    <input id="q_thu" placeholder="THURSDAY">
    <input id="q_thu_rate" placeholder="THU Rate">
    <input id="q_thu_vol" placeholder="THU Vol (L)">
    <input id="q_thu_chem" placeholder="THU Chemical">
    <input id="q_thu_area" placeholder="THU Area">
    <input id="q_thu_mode" placeholder="THU Mode">

    <input id="q_fri" placeholder="FRIDAY">
    <input id="q_fri_rate" placeholder="FRI Rate">
    <input id="q_fri_vol" placeholder="FRI Vol (L)">
    <input id="q_fri_chem" placeholder="FRI Chemical">
    <input id="q_fri_area" placeholder="FRI Area">
    <input id="q_fri_mode" placeholder="FRI Mode">

    <input id="q_sat" placeholder="SATURDAY">
    <input id="q_sat_rate" placeholder="SAT Rate">
    <input id="q_sat_vol" placeholder="SAT Vol (L)">
    <input id="q_sat_chem" placeholder="SAT Chemical">
    <input id="q_sat_area" placeholder="SAT Area">
    <input id="q_sat_mode" placeholder="SAT Mode">

    <input id="q_sun" placeholder="SUNDAY">
    <input id="q_sun_rate" placeholder="SUN Rate">
    <input id="q_sun_vol" placeholder="SUN Vol (L)">
    <input id="q_sun_chem" placeholder="SUN Chemical">
    <input id="q_sun_area" placeholder="SUN Area">
    <input id="q_sun_mode" placeholder="SUN Mode">

    <input id="q_target" list="dl_target" placeholder="Target">
    <input id="q_just" list="dl_just" placeholder="Justification">
    <input id="q_morning" list="dl_morn" placeholder="Morning">
    <input id="q_evening" list="dl_eve" placeholder="Evening">
    <input id="q_preparedBy" list="dl_prep" placeholder="Prepared By">
    <input id="q_agronomistRemarks" list="dl_ar" placeholder="Agronomist Remarks">
    <input id="q_supervisorRemarks" list="dl_sr" placeholder="Supervisor Remarks">
  </div>

  <div class="tools">
    <button onclick="addRow()">Add Row</button>
    <input type="file" id="excel" accept=".xlsx,.xlsm,.xls,.csv">
    <button onclick="importExcel()">Import Excel (merge)</button>
    <button onclick="exportExcel()">Export Excel</button>
    <button onclick="saveAll()">Save Table</button>

    <div class="searchbox">
      <!-- Added FARM, GH, TIME filters in search -->
      <input id="filter_farm" placeholder="Filter Farm">
      <input id="filter_gh" placeholder="Filter GH">
      <input id="filter_time" placeholder="Filter TIME">
      <input id="q" placeholder="Search all...">
      <button onclick="search()">Search</button>
      <button onclick="clearSearch()">Clear</button>
    </div>
  </div>

  <datalist id="dl_farm"></datalist>
  <datalist id="dl_gh"></datalist>
  <datalist id="dl_area"></datalist>
  <datalist id="dl_crop"></datalist>
  <datalist id="dl_variety"></datalist>
  <datalist id="dl_mode"></datalist>
  <datalist id="dl_method"></datalist>
  <datalist id="dl_time"></datalist>
  <datalist id="dl_target"></datalist>
  <datalist id="dl_just"></datalist>
  <datalist id="dl_morn"></datalist>
  <datalist id="dl_eve"></datalist>
  <datalist id="dl_prep"></datalist>
  <datalist id="dl_ar"></datalist>
  <datalist id="dl_sr"></datalist>

  <div class="table-wrap">
    <table id="tbl">
      <thead>
  <tr>
    <th class="top" rowspan="2">ID</th>
    <th class="top" rowspan="2">Farm</th>
    <th class="top" rowspan="2">GH</th>
    <th class="top" rowspan="2">AREA</th>
    <th class="top" rowspan="2">CROP</th>
    <th class="top" rowspan="2">VARIETY</th>
    <th class="top" rowspan="2">MODE</th>
    <th class="top" rowspan="2">METHOD</th>
    <th class="top" rowspan="2">TIME</th>

    <th class="top" colspan="6">MON</th>
    <th class="top" colspan="6">TUE</th>
    <th class="top" colspan="6">WED</th>
    <th class="top" colspan="6">THU</th>
    <th class="top" colspan="6">FRI</th>
    <th class="top" colspan="6">SAT</th>
    <th class="top" colspan="6">SUN</th>

    <!-- ðŸ‘‡ Move these to the end -->
    <th class="top" rowspan="2">Target</th>
    <th class="top" rowspan="2">Justification</th>
    <th class="top" rowspan="2">Morning</th>
    <th class="top" rowspan="2">Evening</th>
    <th class="top" rowspan="2">Prepared By</th>
    <th class="top" rowspan="2">Agronomist Remarks</th>
    <th class="top" rowspan="2">Supervisor Remarks</th>
  </tr>
  <tr>
    <!-- Subheaders for each day -->
    <th class="sub">monday</th><th class="sub">Rate</th><th class="sub">Vol(L)</th><th class="sub">Chemical</th><th class="sub">Area</th><th class="sub">Mode</th>
    <th class="sub">tuesday</th><th class="sub">Rate</th><th class="sub">Vol(L)</th><th class="sub">Chemical</th><th class="sub">Area</th><th class="sub">Mode</th>
    <th class="sub">wednesday</th><th class="sub">Rate</th><th class="sub">Vol(L)</th><th class="sub">Chemical</th><th class="sub">Area</th><th class="sub">Mode</th>
    <th class="sub">thursday</th><th class="sub">Rate</th><th class="sub">Vol(L)</th><th class="sub">Chemical</th><th class="sub">Area</th><th class="sub">Mode</th>
    <th class="sub">friday</th><th class="sub">Rate</th><th class="sub">Vol(L)</th><th class="sub">Chemical</th><th class="sub">Area</th><th class="sub">Mode</th>
    <th class="sub">saturday</th><th class="sub">Rate</th><th class="sub">Vol(L)</th><th class="sub">Chemical</th><th class="sub">Area</th><th class="sub">Mode</th>
    <th class="sub">sunday</th><th class="sub">Rate</th><th class="sub">Vol(L)</th><th class="sub">Chemical</th><th class="sub">Area</th><th class="sub">Mode</th>
  </tr>
</thead>

      <tbody></tbody>
    </table>
  </div>

<script>
// --- All your previous JS remains unchanged except search ---
// --- JS remains exactly as your previous code, unchanged ---
/* Utility helpers */
const $ = id => document.getElementById(id);
const ce = v => v == null ? '' : String(v);

/* Master copy and filtered copy */
let allRows = [];  // full dataset from server
let rows = [];     // current displayed (filtered) rows


/* Render functions */
function rowToHTML(row) {
  const v = k => ce(row[k]);
  // All columns are rendered contenteditable except ID (first cell)
  return `<tr data-id="${v('id') || ''}">
    <td>${v('id') || ''}</td>
    <td contenteditable="true">${v('farm')}</td>
    <td contenteditable="true">${v('gh')}</td>
    <td contenteditable="true">${v('area')}</td>
    <td contenteditable="true">${v('crop')}</td>
    <td contenteditable="true">${v('variety')}</td>
    <td contenteditable="true">${v('mode')}</td>
    <td contenteditable="true">${v('method')}</td>
    <td contenteditable="true">${v('time')}</td>

    <td contenteditable="true">${v('mon')}</td><td contenteditable="true">${v('mon_rate')}</td><td contenteditable="true">${v('mon_vol')}</td><td contenteditable="true">${v('mon_chemical')}</td><td contenteditable="true">${v('mon_area')}</td><td contenteditable="true">${v('mon_mode')}</td>

    <td contenteditable="true">${v('tue')}</td><td contenteditable="true">${v('tue_rate')}</td><td contenteditable="true">${v('tue_vol')}</td><td contenteditable="true">${v('tue_chemical')}</td><td contenteditable="true">${v('tue_area')}</td><td contenteditable="true">${v('tue_mode')}</td>

    <td contenteditable="true">${v('wen')}</td><td contenteditable="true">${v('wed_rate')}</td><td contenteditable="true">${v('wed_vol')}</td><td contenteditable="true">${v('wed_chemical')}</td><td contenteditable="true">${v('wed_area')}</td><td contenteditable="true">${v('wed_mode')}</td>

    <td contenteditable="true">${v('thu')}</td><td contenteditable="true">${v('thu_rate')}</td><td contenteditable="true">${v('thu_vol')}</td><td contenteditable="true">${v('thu_chemical')}</td><td contenteditable="true">${v('thu_area')}</td><td contenteditable="true">${v('thu_mode')}</td>

    <td contenteditable="true">${v('fri')}</td><td contenteditable="true">${v('fri_rate')}</td><td contenteditable="true">${v('fri_vol')}</td><td contenteditable="true">${v('fri_chemical')}</td><td contenteditable="true">${v('fri_area')}</td><td contenteditable="true">${v('fri_mode')}</td>

    <td contenteditable="true">${v('sat')}</td><td contenteditable="true">${v('sat_rate')}</td><td contenteditable="true">${v('sat_vol')}</td><td contenteditable="true">${v('sat_chemical')}</td><td contenteditable="true">${v('sat_area')}</td><td contenteditable="true">${v('sat_mode')}</td>

    <td contenteditable="true">${v('sun')}</td><td contenteditable="true">${v('sun_rate')}</td><td contenteditable="true">${v('sun_vol')}</td><td contenteditable="true">${v('sun_chemical')}</td><td contenteditable="true">${v('sun_area')}</td><td contenteditable="true">${v('sun_mode')}</td>

    <td contenteditable="true">${v('target')}</td><td contenteditable="true">${v('justification')}</td><td contenteditable="true">${v('morning')}</td><td contenteditable="true">${v('evening')}</td><td contenteditable="true">${v('preparedBy')}</td><td contenteditable="true">${v('agronomistRemarks')}</td><td contenteditable="true">${v('supervisorRemarks')}</td>
  </tr>`;
}

function render() {
  $('tbl').querySelector('tbody').innerHTML = rows.map(r => rowToHTML(r)).join('');
  buildDatalists(rows);
}

/* Datalist helpers */
function unique(arr, key) {
  const s = new Set();
  arr.forEach(x => { if (x && x[key]) s.add(String(x[key])); });
  return [...s].sort();
}
function fillDL(id, vals) {
  const dl = $(id);
  const have = new Set(Array.from(dl.children).map(o => o.value));
  vals.forEach(v => { if (!have.has(v)) { const opt = document.createElement('option'); opt.value = v; dl.appendChild(opt); }});
}
function buildDatalists(data) {
  fillDL('dl_farm', unique(data, 'farm'));
  fillDL('dl_gh', unique(data, 'gh'));
  fillDL('dl_area', unique(data, 'area'));
  fillDL('dl_crop', unique(data, 'crop'));
  fillDL('dl_variety', unique(data, 'variety'));
  fillDL('dl_mode', unique(data, 'mode'));
  fillDL('dl_method', unique(data, 'method'));
  fillDL('dl_time', unique(data, 'time'));
  fillDL('dl_target', unique(data, 'target'));
  fillDL('dl_just', unique(data, 'justification'));
  fillDL('dl_morn', unique(data, 'morning'));
  fillDL('dl_eve', unique(data, 'evening'));
  fillDL('dl_prep', unique(data, 'preparedBy'));
  fillDL('dl_ar', unique(data, 'agronomistRemarks'));
  fillDL('dl_sr', unique(data, 'supervisorRemarks'));
}

/* Load from server */
async function load(){
  try {
    const res = await fetch('/agro', { credentials: 'same-origin' });
    if(!res.ok) { if(res.status===401) location.href='login.html'; else throw new Error('Load failed'); }
    allRows = await res.json();
    rows = [...allRows];   // copy full set into current display
    render();
  } catch (err) {
    console.error(err);
    alert('Failed loading agronomist data');
  }
}

/* Add quick row - calls /agro/add */
async function addRow() {
  const payload = {
    farm: $('q_farm').value.trim(), gh: $('q_gh').value.trim(), area: $('q_area').value.trim(),
    crop: $('q_crop').value.trim(), variety: $('q_variety').value.trim(), mode: $('q_mode').value.trim(),
    method: $('q_method').value.trim(), time: $('q_time').value.trim(),

   mon: $('q_mon').value.trim(),
mon_rate: $('q_mon_rate').value.trim(),
mon_vol: $('q_mon_vol').value.trim(),
mon_chemical: $('q_mon_chem').value.trim(),
mon_area: $('q_mon_area').value.trim(),
mon_mode: $('q_mon_mode').value.trim(),

tue: $('q_tue').value.trim(),
tue_rate: $('q_tue_rate').value.trim(),
tue_vol: $('q_tue_vol').value.trim(),
tue_chemical: $('q_tue_chem').value.trim(),
tue_area: $('q_tue_area').value.trim(),
tue_mode: $('q_tue_mode').value.trim(),

wed: $('q_wed').value.trim(),
wed_rate: $('q_wed_rate').value.trim(),
wed_vol: $('q_wed_vol').value.trim(),
wed_chemical: $('q_wed_chem').value.trim(),
wed_area: $('q_wed_area').value.trim(),
wed_mode: $('q_wed_mode').value.trim(),

thu: $('q_thu').value.trim(),
thu_rate: $('q_thu_rate').value.trim(),
thu_vol: $('q_thu_vol').value.trim(),
thu_chemical: $('q_thu_chem').value.trim(),
thu_area: $('q_thu_area').value.trim(),
thu_mode: $('q_thu_mode').value.trim(),

fri: $('q_fri').value.trim(),
fri_rate: $('q_fri_rate').value.trim(),
fri_vol: $('q_fri_vol').value.trim(),
fri_chemical: $('q_fri_chem').value.trim(),
fri_area: $('q_fri_area').value.trim(),
fri_mode: $('q_fri_mode').value.trim(),

sat: $('q_sat').value.trim(),
sat_rate: $('q_sat_rate').value.trim(),
sat_vol: $('q_sat_vol').value.trim(),
sat_chemical: $('q_sat_chem').value.trim(),
sat_area: $('q_sat_area').value.trim(),
sat_mode: $('q_sat_mode').value.trim(),

sun: $('q_sun').value.trim(),
sun_rate: $('q_sun_rate').value.trim(),
sun_vol: $('q_sun_vol').value.trim(),
sun_chemical: $('q_sun_chem').value.trim(),
sun_area: $('q_sun_area').value.trim(),
sun_mode: $('q_sun_mode').value.trim(),


    target: $('q_target').value.trim(), justification: $('q_just').value.trim(), morning: $('q_morning').value.trim(),
    evening: $('q_evening').value.trim(), preparedBy: $('q_preparedBy').value.trim(), agronomistRemarks: $('q_agronomistRemarks').value.trim(), supervisorRemarks: $('q_supervisorRemarks').value.trim()
  };

  try {
    const res = await fetch('/agro/add', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const d = await res.json();
    if (!d.success) { alert('Add failed: ' + (d.message || 'server error')); return; }
    // clear quick inputs
    Array.from(document.querySelectorAll('#quickAdd input')).forEach(i => i.value = '');
    await load();
  } catch (err) {
    console.error(err);
    alert('Add failed');
  }
}

async function saveAll() {
  // Read only the currently displayed (possibly filtered) rows
  const arr = readTableToArray();

  // âœ… Merge table edits back into the master dataset (allRows)
  allRows = allRows.map(r => {
    const updated = arr.find(u => u.id === r.id);
    return updated ? updated : r;
  });

  // âœ… Add any brand-new rows that donâ€™t have an ID yet
  arr.forEach(r => {
    if (!r.id || !allRows.find(existing => existing.id === r.id)) {
      allRows.push(r);
    }
  });

  try {
    const res = await fetch('/agro/bulk_set', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(allRows)   // âœ… save the full dataset
    });
    const d = await res.json();
    if (!d.success) {
      alert('Save failed');
      return;
    }
    alert(`Saved ${d.count} rows`);
    await load();   // reload everything fresh
  } catch (err) {
    console.error(err);
    alert('Save failed');
  }
}


function readTableToArray() {
  const out = [];
  document.querySelectorAll('#tbl tbody tr').forEach(tr => {
    const c = tr.children;
    out.push({
      id: Number(c[0].innerText.trim()) || undefined,
      farm: c[1].innerText.trim(),
      gh: c[2].innerText.trim(),
      area: c[3].innerText.trim(),
      crop: c[4].innerText.trim(),
      variety: c[5].innerText.trim(),
      mode: c[6].innerText.trim(),
      method: c[7].innerText.trim(),
      time: c[8].innerText.trim(),

      mon_rate: c[9].innerText.trim(), mon_vol: c[10].innerText.trim(), mon_chemical: c[11].innerText.trim(), mon_area: c[12].innerText.trim(), mon_mode: c[13].innerText.trim(),
      tue_rate: c[14].innerText.trim(), tue_vol: c[15].innerText.trim(), tue_chemical: c[16].innerText.trim(), tue_area: c[17].innerText.trim(), tue_mode: c[18].innerText.trim(),
      wed_rate: c[19].innerText.trim(), wed_vol: c[20].innerText.trim(), wed_chemical: c[21].innerText.trim(), wed_area: c[22].innerText.trim(), wed_mode: c[23].innerText.trim(),
      thu_rate: c[24].innerText.trim(), thu_vol: c[25].innerText.trim(), thu_chemical: c[26].innerText.trim(), thu_area: c[27].innerText.trim(), thu_mode: c[28].innerText.trim(),
      fri_rate: c[29].innerText.trim(), fri_vol: c[30].innerText.trim(), fri_chemical: c[31].innerText.trim(), fri_area: c[32].innerText.trim(), fri_mode: c[33].innerText.trim(),
      sat_rate: c[34].innerText.trim(), sat_vol: c[35].innerText.trim(), sat_chemical: c[36].innerText.trim(), sat_area: c[37].innerText.trim(), sat_mode: c[38].innerText.trim(),
      sun_rate: c[39].innerText.trim(), sun_vol: c[40].innerText.trim(), sun_chemical: c[41].innerText.trim(), sun_area: c[42].innerText.trim(), sun_mode: c[43].innerText.trim(),

      target: c[51].innerText.trim(),
      justification: c[52].innerText.trim(),
      morning: c[53].innerText.trim(),
      evening: c[54].innerText.trim(),
      preparedBy: c[55].innerText.trim(),
      agronomistRemarks: c[56].innerText.trim(),
      supervisorRemarks: c[57].innerText.trim()
    });
  });
  return out;
}

/* Client-side Excel import (merge) */
function normalizeKey(k){
  return (k || '').toString().trim().toLowerCase()
    .replace(/\s+/g,' ')
    .replace(/[^a-z0-9 ]/g,'');
}

function mapSheetRowToRecord(sheetRow){
  // sheetRow keys are the column headings from the Excel
  // We'll map common labels to our internal keys
  const out = {};
  for (const rawKey of Object.keys(sheetRow)){
    const value = sheetRow[rawKey];
    const k = normalizeKey(rawKey);
    // check common possibilities
    if (k.match(/^(id|identifier)$/)) out.id = value;
    else if (k.includes('farm')) out.farm = value;
    else if (k.match(/\bgh\b/) || k.includes('greenhouse')) out.gh = out.gh || value;
    else if (k.includes('area')) {
      // ambiguous area: if column contains 'mon area' etc keep it
      if (k.startsWith('mon ')) out.mon_area = value;
      else if (k.startsWith('tue ')) out.tue_area = value;
      else if (k.startsWith('wed ')) out.wed_area = value;
      else if (k.startsWith('thu ')) out.thu_area = value;
      else if (k.startsWith('fri ')) out.fri_area = value;
      else if (k.startsWith('sat ')) out.sat_area = value;
      else if (k.startsWith('sun ')) out.sun_area = value;
      else out.area = value;
    }
    else if (k.includes('crop')) out.crop = value;
    else if (k.includes('variet') || k.includes('variety')) out.variety = value;
    else if (k.includes('mode') && !k.includes('mon') && !k.includes('tue') && !k.includes('wed') && !k.includes('thu') && !k.includes('fri') && !k.includes('sat') && !k.includes('sun')) out.mode = value;
    else if (k.includes('method')) out.method = value;
    else if (k.includes('time')) out.time = value;

    // day-specific
    else if (k.startsWith('mon ') || k.includes('mon_')) {
      if (k.includes('rate')) out.mon_rate = value;
      else if (k.includes('vol')) out.mon_vol = value;
      else if (k.includes('chemical')) out.mon_chemical = value;
      else if (k.includes('mode')) out.mon_mode = value;
      else if (k.includes('area')) out.mon_area = value;
    } else if (k.startsWith('tue ') || k.includes('tue_')) {
      if (k.includes('rate')) out.tue_rate = value;
      else if (k.includes('vol')) out.tue_vol = value;
      else if (k.includes('chemical')) out.tue_chemical = value;
      else if (k.includes('mode')) out.tue_mode = value;
      else if (k.includes('area')) out.tue_area = value;
    } else if (k.startsWith('wed ') || k.includes('wed_')) {
      if (k.includes('rate')) out.wed_rate = value;
      else if (k.includes('vol')) out.wed_vol = value;
      else if (k.includes('chemical')) out.wed_chemical = value;
      else if (k.includes('mode')) out.wed_mode = value;
      else if (k.includes('area')) out.wed_area = value;
    } else if (k.startsWith('thu ') || k.includes('thu_') || k.includes('thur')) {
      if (k.includes('rate')) out.thu_rate = value;
      else if (k.includes('vol')) out.thu_vol = value;
      else if (k.includes('chemical')) out.thu_chemical = value;
      else if (k.includes('mode')) out.thu_mode = value;
      else if (k.includes('area')) out.thu_area = value;
    } else if (k.startsWith('fri ') || k.includes('fri_')) {
      if (k.includes('rate')) out.fri_rate = value;
      else if (k.includes('vol')) out.fri_vol = value;
      else if (k.includes('chemical')) out.fri_chemical = value;
      else if (k.includes('mode')) out.fri_mode = value;
      else if (k.includes('area')) out.fri_area = value;
    } else if (k.startsWith('sat ') || k.includes('sat_')) {
      if (k.includes('rate')) out.sat_rate = value;
      else if (k.includes('vol')) out.sat_vol = value;
      else if (k.includes('chemical')) out.sat_chemical = value;
      else if (k.includes('mode')) out.sat_mode = value;
      else if (k.includes('area')) out.sat_area = value;
    } else if (k.startsWith('sun ') || k.includes('sun_')) {
      if (k.includes('rate')) out.sun_rate = value;
      else if (k.includes('vol')) out.sun_vol = value;
      else if (k.includes('chemical')) out.sun_chemical = value;
      else if (k.includes('mode')) out.sun_mode = value;
      else if (k.includes('area')) out.sun_area = value;
    } else if (k.includes('target')) out.target = value;
    else if (k.includes('justif')) out.justification = value;
    else if (k.includes('morning')) out.morning = value;
    else if (k.includes('evening')) out.evening = value;
    else if (k.includes('prepared')) out.preparedBy = value;
    else if (k.includes('agronomist')) out.agronomistRemarks = value;
    else if (k.includes('supervisor')) out.supervisorRemarks = value;
    // fallback: try to map common short names like rate, vol etc without day prefix
    else if (k === 'rate') out.mon_rate = out.mon_rate || value;
    else if (k === 'vol' || k === 'volume') out.mon_vol = out.mon_vol || value;
  }
  return out;
}

async function importExcel(){
  const f = $('excel').files[0];
  if(!f){ alert('Choose an Excel file to import'); return; }

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const dataBuff = new Uint8Array(e.target.result);
      const wb = XLSX.read(dataBuff, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const arr = XLSX.utils.sheet_to_json(ws, { defval: '' });

      // map
      const mapped = arr.map(r => mapSheetRowToRecord(r));

      // fetch existing rows from server
      const res = await fetch('/agro', { credentials: 'same-origin' });
      if(!res.ok){ alert('Unable to load existing rows (session?)'); return; }
      const existing = await res.json();

      // Merge: append imported rows to existing. Avoid duplicates if identical entire record exists.
      const combined = existing.slice();
      mapped.forEach(m => {
        // check if identical exists (basic check by JSON string of mapped core keys)
        const key = JSON.stringify([
          m.farm||'', m.gh||'', m.area||'', m.crop||'', m.variety||'', m.time||'', m.method||'',
          m.mon_rate||'', m.tue_rate||'', m.wed_rate||'', m.thu_rate||'', m.fri_rate||'', m.sat_rate||'', m.sun_rate||''
        ]);
        const exists = combined.some(e => JSON.stringify([
          e.farm||'', e.gh||'', e.area||'', e.crop||'', e.variety||'', e.time||'', e.method||'',
          e.mon_rate||'', e.tue_rate||'', e.wed_rate||'', e.thu_rate||'', e.fri_rate||'', e.sat_rate||'', e.sun_rate||''
        ]) === key);
        if(!exists) combined.push(m);
      });

      // send merged to server bulk_set
      const saveRes = await fetch('/agro/bulk_set', {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(combined)
      });
      const sd = await saveRes.json();
      if(!sd.success){ alert('Import save failed'); return; }
      alert('Imported and merged successfully');
      await load();
    } catch (err) {
      console.error(err);
      alert('Import failed: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(f);
}

/* Export - client side using SheetJS */
function exportExcel(){
  // use current table rows (readTableToArray() will reflect edits)
  const arr = readTableToArray();
  const ws = XLSX.utils.json_to_sheet(arr);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'AgronomistData');
  XLSX.writeFile(wb, 'agronomist_export.xlsm');
}



/* Logout */
async function logout(){
  await fetch('/logout', { method:'POST', credentials: 'same-origin' });
  location.href = 'login.html';
}
async function search(){
  const q = ($('q').value || '').trim();
  const fFarm = ($('filter_farm').value || '').trim();
  const fGH = ($('filter_gh').value || '').trim();
  const fTime = ($('filter_time').value || '').trim();

  // Build query params
  const params = new URLSearchParams();
  if(q) params.append('q', q);
  if(fFarm) params.append('farm', fFarm);
  if(fGH) params.append('gh', fGH);
  if(fTime) params.append('time', fTime);

  try {
    const res = await fetch('/agro/search?' + params.toString(), { credentials: 'same-origin' });
    if(!res.ok) throw new Error('Server search failed');
    rows = await res.json();   // search results
    render();
// âœ… Keep allRows unchanged so history data remains safe

  } catch(err){
    console.error(err);
    alert('Search failed: ' + err.message);
  }
}

function clearSearch(){
  $('q').value = '';
  $('filter_farm').value = '';
  $('filter_gh').value = '';
  $('filter_time').value = '';
  
  rows = [...allRows];   // restore full dataset
  render();

}

// Load historical data when the page first opens
window.addEventListener("DOMContentLoaded", load);

</script>
</body>
</html>
